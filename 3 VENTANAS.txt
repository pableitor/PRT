//version 6.0 incluye posibilidad de safety zone en forma de cuña, segun el parametro COEF podemos ajustar la rapidez con la que se va cerrando la cuña.
// las condiciones de largo y corto se definen en un indicador externo llamado "CONDICIONESxxxx" que devuelve 1 para largos y -1 para cortos

DEFPARAM PRELOADBARS =1000
DEFPARAM CumulateOrders = False // Acumulación de posiciones desactivada


// las condiciones de largo y corto se definen en un indicador externo llamado condiciones que devuelve 1 para largos y -1 para cortos, c10 salida de largos , c12 salida de cortos
HORAINICIO=090000//HORA: HORA DE COMIENZO DE OPERACIONES
HoraCIERRE = 210000 //HORA DE LA ULTIMA OPERACION
SPREAD=1

NMAX =22//NUMERO MAXIMO DE COBERTURAS EN CADA OPERACION
MAXOP = 1//NUMERO MAXIMO DE ENTRADAS AL DIA
BEN= 10//BENEFICIO DE LA OPERACION DE COBERTURA PIPS POR CONTRATO
//x = 1
//ST=35// NUM PIPS HASTA ACTIVAR LA COBERTURA
TP=x * ST// NUM DE PIPS DESDE SL HASTA TAKE PROFIT, x = 1...3 aprox para no multiplicar mucho el numero de contratos
C=1// NUMERO DE CONTRATOS INICIALES
ONCE N=0 //CONTADOR DE COBERTURAS
ONCE OPENP=0// TIPO DE POSICION ABIERTA +1 LARGOS , -1 CORTOS, 0 CERRADO
ONCE MAXLOSS=0 // PERDIDAS ACUMULADAS AL ABRIR CADA COBERTURA
COEF = 1 //coef para modificar safety zone: <1 comprime, >1 expande. Si expande el num. de contratos será menor pero mas dificil cerrar la operacion
B = BEN * C
// coeficiente de reduccion de la zona de coberturas
//ALGUNOS PARAMETROS EN m1
//BITCOIN: SPREAD 20 ST 80, TP 200
//DAX SPREAD 1 ST12 TP 25
//DOW SPREAD 2 ST12 TP25 NMAX=8

// Impide al sistema crear nuevas órdenes para entrar al mercado a aumentar el tamaño de la posición antes de una hora precisa

timeEnterBefore = time >= HORAINICIO

// Impide al sistema lanzar nuevas órdenes para entrar al mercado o aumentar el tamaño de la posición después de una hora precisa

timeEnterAfter = time < HORACIERRE

// Impide al sistema operar en días precisos de la semana
daysForbiddenEntry = OpenDayOfWeek = 6 OR OpenDayOfWeek = 0
// ventana de horario de apertura de operaciones entre HORA y HORACIERRE
allow = timeEnterBefore AND timeEnterAfter AND not daysForbiddenEntry


IF not onmarket and (OpenTime = HORAINICIO ) THEN //si estamos fuera actualiza PA
PA = Open[0]
OPDAY=0 //CONTADOR DE OPEARCIONES DIARIAS
openp=0
n=0
ENDIF

//IF PA=0 THEN
//PA = Open[0]
//ENDIF
//COMPRUEBA EL INSTRUMEENTO PARA CALCULAR LAS BANDAS DE PRECIO
IF PA < 2 THEN //DIVISA
K=10000
ELSE
IF PA <200 THEN //EURJPY
K=100
ELSE
IF PA < 3000 THEN //GOLD & SP
K=10
ELSE
K=1 // INDICES
ENDIF
ENDIF
ENDIF
//graph pointsize
TP2=TP/K //MODIFICA LAS BANDAS DE TP Y ST SEGUN EL INSTRUMENTO
ST2=ST/K
B2=B/K
SPREAD2=SPREAD/K

AbrirLargos , AbrirCortos , CierreLargos, CierreCortos= CALL"condiciones"

IF NOT ONMARKET[1] AND ONMARKET THEN
PA= TRADEPRICE //precio de entrada
//GRAPH PA
ENDIF

//GRAPH OPDAY AS "DAILY"
//graph n as "n"
//**** APERTURA DE POSICIONES SEGUN EL SISTEMA ****//
IF N=0 AND OPENP=0 and allow AND OPDAY < MAXOP THEN//ESTAMOS CERRADOS, COMPROBAR SI SE CUMPLE CONDICIONES PARA ABRIR y estamos dentro de la ventana de tiempo
IF AbrirLargos  THEN//CONDICIONES DEL SISTEMA PARA ABRIR LARGOS
PA = close+SPREAD2/2
ENTRADA = PA
//R01A = PA + TP2
R01B = PA + TP2
S01A = PA - ST2+SPREAD2
S01B = PA - ST2 - TP2
C0=C//INICIALIZA NUM. CONTRATOS
BUY C0 CONTRACTS AT MARKET
//GRAPH PA
OPENP=1 //INDICA LARGOS
N=0
OPDAY = OPDAY+1
U=-1
ENDIF
IF AbrirCortos THEN//CONDICIONES DEL SISTEMA PARA ABRIR CORTOS
//ABRE POSICION CORTOS
PA = close-SPREAD2/2
ENTRADA = PA
//R01A = PA + ST2
R01B = PA + ST2 + TP2
R01A = PA + ST2
S01B = PA - TP2
S01A = PA - TP2
C0=C//INICIALIZA NUM. CONTRATOS
SELLSHORT C0 CONTRACTS AT MARKET
//GRAPH PA
OPENP=-1 //INDICA CORTOS
N=0
OPDAY = OPDAY+1
U=-1

ENDIF
//** FIN DE BLOQUE DE APERTURA DE ORDENES SEGUN SISTEMA

ELSE
//***** PRIMERO CHEQUEAR CIERRE POSICIONES SEGUN EL SISTEMA
//GRAPH PA
IF ( OPENP=1 ) THEN // COMPRUEBA POSIBLE CIERRE DE LARGOS

//C10 CONDICION PARA CERRAR LARGOS : CAMBIO DE VELA HEIKEN ASHI DE VERDEA  ROJO
C11 = (CLOSE- SPREAD2/2)>=ENTRADA


IF N=0 AND CierreLargos AND C11  THEN //N=0 INDICA NO ESTAMOS EN COBERTURAS. SOLO CIERRA POSICION SI SE CUMPLE LA CONDICION Y HAY GANANCIA, SI ESTUVIERAMOS EN PERDIDAS NO CERRAMOS
SELL AT MARKET
OPENP=0
ENDIF
ELSE// COMPRUEBA SI CERRAMOS CORTOS SEGUN EL SISTEMA (SIN COBERTURAS)
//C12 CONDICION PARA CERRAR CORTOS : CAMBIO DE VELA HEIKEN ASHI DE ROJO A VERDE
C11 = CLOSE+SPREAD2/2<=ENTRADA
IF N=0 AND CierreCortos AND C11 THEN //CIERRE DE CORTOS CUANDO NO ESTAMOS EN COBERTURA Y CAMBIA LA VELA H.A. DE ROJO A VERDE
EXITSHORT AT MARKET
OPENP=0

ENDIF// ****FIN COMPROBACION CIERRE CORTOS SEGUN SISTEMA
ENDIF// ****FIN DEL BLOQUE DE CIERRE DE CORTOS / LARGOS SEGUN EL SISTEMA

// ***  COMIENZO BLOQUE COBERTURAS INDEPENDIENTE DEL SISTEMA **//

IF openp=1  THEN//COMPROBAR SI HAY QUE CERRAR O ABRIR COBERTURA DE LARGOS
IF ( HIGH >= R01B  OR LOW <= S01B ) AND N>0 THEN //CERRAMOS COBERTURA CUANDO EL PRECIO CRUZA EL TP
R01B = PA
S01B = PA
S01A = PA
OPENP=0
N=0
MAXLOSS=0
C0=C
SELL AT MARKET
EXITSHORT AT MARKET
ELSE // CONTROL DE PRIMERA O SIGUIENTES COBERTURAS DE LARGOS
//CALCULAR CONTRATOS COBERTURA
TMP = MAXLOSS-C0*ST2*exp(N *log(COEF))//PROREALCODE NO TIENE X^Y , SIMULAMOS X^Y = e ^ ln (x^y) = e^(y * ln x )
CTMP=(B2-TMP)/ (TP2*exp((N+1)*log(COEF)))

// 1ª COBERTURA LARGOS: ABRE CORTOS ON STOP PA-ST2
IF N MOD 2 = 0 AND N<NMAX THEN //ESTAMOS EN ENTRADA Ó COBERTURA 2,4...
SELLSHORT CTMP CONTRACTS AT S01A+spread2 STOP
PA=S01A - U * ST2 * EXP( (N+1)*LOG(COEF) )
S01B = S01A + U * TP2 * EXP ( (N+1) * LOG(COEF) )
//GRAPH S01A-I
SET TARGET PROFIT S01A-S01B
IF N=0 THEN
SET TARGET PPROFIT 200/K //abrimos el TAKEPROFIT EN LA PRIMERA ENTRADA
ENDIF
IF SHORTONMARKET THEN//SE HAN ACTIVADO LA COBERTURA 1,3,5,..
N=N+1
U=-U
C0=CTMP
MAXLOSS=TMP
ENDIF
ELSIF N MOD 2 =1 AND N < NMAX THEN //ESTAMOS EN COBERTURA 1,3,5...
S01A= PA - U * ST2 * EXP((N+1) * LOG(COEF))
R01B= PA + U * TP2 * EXP((N+1) * LOG(COEF))
BUY CTMP CONTRACTS AT PA STOP
SET TARGET PROFIT R01B-PA+SPREAD2
IF LONGONMARKET  THEN
N=N+1
U=-U
C0=CTMP
MAXLOSS=TMP
ENDIF
ENDIF
ENDIF//FIN BLOQUE COMPROBACION COBERTURA DE LARGOS
ELSIF OPENP=-1  THEN//** BLOQUE COMPROBACION DE APERTURA O CIERRE DE COBERTURA DE CORTOS
IF ( HIGH >= R01B  OR LOW <= S01B  ) AND N>0 THEN //CERRAMOS CUANDO EL PRECIO CRUZA EL TP POR ARRIBA O POR ABAJO
R01B = PA
R01A = PA
S01B = PA
S01A = PA
OPENP=0
N=0
MAXLOSS=0
C0=C
SELL AT MARKET
EXITSHORT AT MARKET
ELSE // BLOQUE COBERTURA CORTOS - CALCULO CONTRATOS DE COBERTURA
TMP = MAXLOSS-C0*ST2*exp(N *log(COEF))//PROREALCODE NO TIENE X^Y , SIMULAMOS X^Y = e ^ ln (x^y) = e^(y * ln x )
CTMP=(B2-TMP)/ (TP2*exp((N+1)*log(COEF)))
// 1ª COBERTURA cortos: ABRE CORTOS ON STOP PA+ST2
IF N MOD 2 = 0 AND N<NMAX THEN //ESTAMOS EN ENTRADA Ó COBERTURA 2,4...
BUY CTMP CONTRACTS AT R01A-SPREAD2 STOP
PA=R01A + u * ST2 * EXP( (N+1)*LOG(COEF))
R01B = R01A - U * TP2 * EXP ( (N+1) * LOG(COEF) )

SET TARGET PROFIT R01B-R01A
IF N=0 THEN
SET TARGET PPROFIT 200/K //abrimos el TAKEPROFIT EN LA PRIMERA ENTRADA
ENDIF
IF LONGONMARKET THEN//SE HAN ACTIVADO LA COBERTURA 1,3,5,..
N=N+1
U=-U
C0=CTMP
MAXLOSS=TMP
ENDIF
ELSIF N MOD 2 =1 AND N < NMAX THEN //ESTAMOS EN COBERTURA 1,3,5...
R01A= PA + U * ST2 * EXP((N+1) * LOG(COEF))
S01B= PA - U * TP2 * EXP((N+1) * LOG(COEF))
S01A=S01B
SELLSHORT CTMP CONTRACTS AT PA STOP
SET TARGET PROFIT PA - S01B + SPREAD2
IF SHORTONMARKET THEN
N=N+1
U=-U
C0=CTMP
MAXLOSS=TMP
ENDIF
ENDIF//FIN APERTURA DE COBERTURAS CORTOS
ENDIF//** FIN BLOQUE COMPROBACION DE COBERTURA CORTOS

ENDIF//**FIN BLOQUE COBERTURAS

ENDIF//*FIN SISTEMA
